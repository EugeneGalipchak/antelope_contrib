.\" @(#)orbampmag.1        1.3 06/03/04
.TH ORBAMPMAG 1 "$Date$"
.SH NAME
orbampmag \- real-time magnitude computation
.SH SYNOPSIS
.nf
\fBorbampmag \fP[-v]    [-start {\fIpktid\fP|\fItime\fP}]    [-number \fInumber\fP]
          [-nowait] [-state \fIstatefile\fP] [-pf \fIparameter_file\fP]
		[-auth_expr \fIauth_expr\fP]   [-target_orbmag \fItorbmag\fP]
 		[-next_target_orbmag \fIntorbmag\fP]  [-make_magtables]
 		[-use_mean] [-use_p2p]
          [{-use_if_not_associated | -use_if_not_defining}]
          \fIorbwf\fP \fIorbdb\fP \fIdbname\fP
.fi
.SH DESCRIPTION
\fBorbampmag\fP is a program that continuously looks for parameter file
packets (/pf/\fItorbmag\fP) on an ORB and computes magnitude whenever a packet
is read. The input parameter file packets are produced by orbassoc(1).
The magnitude is written back to the ORB as a modified
\fI/db/origin\fP packet. Optionally, \fI/db/netmag\fP and
\fI/db/stamag\fP packets may also be written.
It is intended to compute mb,ML,Ms.
Each different magnitude has to be computed in a different instance of \fBorbampmag\fP,
what requires different parameter files for each magnitude.
.SH OPTIONS
.IP "-v"
verbose flag
.IP "-start {pktid|time|OLDEST|NEWEST}"
Where to start in the ORB that contains the origin packets.
This argument is optional.
If this is not specified, then the start will be at the
next newest packet.
.IP "-number number"
How many origin packets to process. This argument is optional.
If this is not specified, then there will be no limit on
the \fInumber\fP of origin packets processed.
.IP "-nowait"
If this is specified, then \fBorbampmag\fP will exit when
the ORB read pointer gets to the most recent packet. If
not specifed, then \fBorbampmag\fP will wait for new packets
to arrive indefinitely.
.IP "-state statefile"
A file for storing start/stop state information.
This argument is optional.
.IP "-pf parameter_file"
Name of program parameter file. This argument is optional.
The actual parameter file name is \fIparameter_file\fP.pf.
The default value of \fIparameter_file\fP is \fBorbampmag\fP.
.IP "-auth_expr auth_expr"
Datascope expression for matching the input author field.
This argument is optional and if not specified, then
the default is \fIorbassoc\fP.
The \fIauth\fP field in all input origin packets is
tested against this expression and if it does NOT match,
then the origin is not processed. Whenever \fBorbampmag\fP
successfully processes an origin, it appends \fImag\fP
onto the \fIauth\fP field before it writes it out.
It is important to set \fIauth_expr\fP so that origin rows
that are written by \fBorbampmag\fP are not re-processed
endlessly.
.IP "-target_orbmag torbmag"
A target name for this instance of \fBorbampmag\fP. Input parameter
file packets will be selected based upon this name.
The name should match the \fBorbampmag\fP target name specified
in orbassoc(1). The default is "orbmag".
These packets are created by \fBorbassoc\fP or \fBorb2dbt\fP and may be modified by various
instances of \fBorbampmag\fP.
.IP "-next_target_orbmag torbmag"
A target file for the next instance of \fBorbampmag\fP. This enables
the independent computation of mb,ML,Ms in different instances of
\fBorbampmag\fP.
.IP "-make_magtables"
If this is set, then the netmag and stamag table rows
will be created and written as ORB packets. Otherwise,
by default, no netmag or stamag rows are created.
.IP "-use_mean"
If this is set, then mean and standard deviation statistics are
used in the network magnitude averages. Otherwise, by
default, median and quartile statistics are used in the
network magnitude averages.
.IP "-use_p2p"
If this is set, then the amplitude is computed as peak2peak/2,
wherever the minimum and maximum amplitude appear in the trace.
By default, the absolute maximum is used.
.IP "{-use_if_not_associated|-use_if_not_defining}"
If -use_if_not_associated is set, then all stations in the
\fBorbampmag\fP parameter file are used regardless if they were
detected and associated with each origin.
If -use_if_not_defining is set, then only stations in the
\fBorbampmag\fP parameter file that are detected and associated with
each origin are used, including stations that are associated
but are not "defining" in the location.
If neither option is set, then, by default, only stations
in the \fBorbampmag\fP parameter file that are detected, associated
and are "defining" in the location for each origin are used.
.IP "orbwf"
The input orb that will contain all of the waveform data.
This argument is required.
.IP "orbdb"
The input/output orb that will contain all of the database rows.
\fI/db/origin\fP packets are read and modified \fI/db/origin\fP
packets are written.
This argument is required.
.IP "dbname"
The name of the database that contains site and instrument
information. The tables used are \fIsite\fP, \fIsensor\fP,
\fIinstrument\fP, and \fIcalibration\fP.
.SH PARAMETER FILE
The \fBorbampmag\fP parameter file must contain a table, named "mag",
that defines a list of all network_stations to be used
for processing magnitude values. An example \fBorbampmag\fP
parameter file is as follows:
.in 2c
.ft CW
.nf

.ne 5

# latency and maxwaittime are only needed for \fBorbampmag\fP
# but to allow the usage of the same parameter file for both
# realtime (\fBorbampmag\fP) computations and postprocessing (dbampmag)
# they are included in the parameterfile

.ne 7
latency     30.0 # group latency
maxwaittime 60.0 # A hard timeout value in seconds for reading
                # waveform packets.  If no waveform packets
                # for the selected channels are received
                # within this time period, then the waveform
                # reading loop is interrupted and any further
                # processing for that event is aborted.

.ne 7

magtype     mb  # valid values are mb, ml and ms of
                # course other parameters have to be
                # set according to this choice

v_r         4.0 # velocity for surface waves used to
                # determine surface wave arrival time

.ne 11
time0       P   # start of measuring time window
                # P - pphasetime (see man pphasetime)
                # S - sphasetime
                # R - rayleigh wave - here we use deg2km(delta) / v_r

time_window 0.5 # The waveform for processing the
                # magnitude is determined by a time window
                # starting from the arrival defined by the
                # time0 parameter to
                # time_factor*(S_time - P_time) seconds
                # after the first P-arrival.

.ne 18
mindelta    0   # distance range in degrees
maxdelta    180 #

# a 'general' magnitude formula could be:
#
#       c0+log10(amp)+c1*log10(delta)+c2*log10(delta*c3+c4)+c5
#
#       delta is the distance in degrees
#       where c2,c3,c4,c5 are station-dependent
#       thus c0 and c1 are to be changed here,
#       while c2,c3,c4,c5 are to be changed station-wise
#
# beware:  c0 has to be converted if you have a formula where delta is
# in km in this case subtract log10(deg2km(1))*c1 from the 'original'
# coefficient
#
c0     -0.104
c1      1.66

.ne 15
filter BW 0.6 3 3 3

mag &Tbl{    # station parameters for computing magnitudes
#                  calib              apply
#      chan        from  deconvolve    wa      snr
#sta   expr         db   instrument  filter threshold latency c2  c3  c4  c5
ARSA   HHZ          yes     no        no       2.0      0.0  0.0 1.0 1.0 0.0
DEMO   HH[ZNE]_00   yes     no        no       2.0      0.0  0.0 1.0 1.0 0.0
}

.fi
.ft R
.in
.LP
The parameters are defined below.
.IP "c0, c1, c2, c3, c4, c5"
define whatever you might find appropriate to compute your magnitudes.
.IP filter
Defines the filter applied to your data
.IP sta
The sta parameter identifies the station.
.IP chan_expr
A regular expression that is matched against the actual css3.0 channel codes.
.IP calib_from_db
If set to yes (or true or 1) then the calib value for
converting counts to ground velocity (or displacement) is obtained
from the database calibration table. Otherwise, calib is obtained directly
from the wfdisc row entries.
.IP decon_instr
If set to yes (or true or 1) then the instrument response
is deconvolved. Otherwise, the instrument response
is not deconvolved.
.IP apply_wa_filter
If set to yes (or true or 1) then the Wood-Anderson filter
is applied. Otherwise, the Wood-Anderson filter
is not applied.
.IP snr_thresh
This is a signal to noise threshold value. The noise for each
waveform preceding the initial P arrival is computed as a
root mean square. If the observed peak value (the signal)
of the event divided by the noise value is less than snr_thresh,
then the magnitude is not computed for the particular channel.
.LP
Applying instrument deconvolution can cause instabilites. For
broadband instruments, it is usually not necessary to apply
instrument deconvolution since the instrument response
is flat in the response band of the Wood-Anderson filter.
In cases where the instrument is a narrow band short period
at 1 Hertz, it is usually not necessary to apply either
the deconvolution or the Wood-Anderson filter. In all cases
the responses are converted to displacement and the correct
gains are applied to produce equivalent Wood-Anderson
drum recorder displacement.
.SH EXAMPLES
This is how I call orbampmag 3 times in rtexec.pf
to compute more or less independent of each other mb,ml,ms.
.LP
orbassoc puts out the default /pf/orbmag packets which are read to compute mb.
This instance then puts /pf/orbml, which is read by another instance that computs ml, etc...
Obviously, the last instance puts nothing back.
.in 2c
.ft CW
.nf

.ne 10

orbmb orbampmag -state state/mb -v -use_p2p \\
            -auth_expr mb -next_target_orbmag orbml \\
            -make_magtables -p mb $ORB $ORB $DB
orbml orbampmag -state state/ml -v -target_orbmag orbml \\
            -auth_expr ml -next_target_orbmag orbms -p ml \\
            -make_magtables $ORB $ORB $DB
orbms orbampmag  -start OLDEST  -state state/ms3 -v -use_p2p \\
            -target_orbmag orbms -auth_expr ms -p ms \\
            -make_magtables $ORB $ORB $DB

.fi
.ft R
.in
This example shows how to run both \fBorbampmag\fP and \fBorbmag\fP together. \fBOrbmag\fP must be called last, as it does not hand over the modified \fI/pf/orbmag/\fP packets.
The auth_expr for orbmag looks a bit strange, but it does the job. 
.in 2c
.ft CW
.nf
.ne 10

orbmb orbampmag -state state/mb -v -use_p2p \\
            -auth_expr mb -next_target_orbmag orbms \\
            -make_magtables -pf mb $ORB $ORB $DB
orbms orbampmag  -start OLDEST  -state state/ms3 -v -use_p2p \\
            -target_orbmag orbms -net_target_orbmag orbml \\
			-auth_expr ms -pf ms \\
            -make_magtables $ORB $ORB $DB
orbml orbmag -state state/ml -v -target_orbmag orbml \\
            -auth_expr "orbassoc.*/ && auth!~/.*ma.*" -p orbmag \\
            -make_magtables $ORB $ORB $DB

.fi
.ft R
.in
.SH "BUGS AND CAVEATS"
Instrument response deconvolution is not supported at this time.
Acceleration sensor channels are not supported at this time.
.SH AUTHOR
Nikolaus Horn, using orbmag by Danny Harvey
.br
ZAMG / Vienna, nikolaus.horn@zamg.ac.at

