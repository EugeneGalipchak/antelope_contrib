.TH DB2SHAKEMAP_XML 1 "$Date$"
.SH NAME
db2shakemap_xml \- create input for USGS ShakeMap from database
.SH SYNOPSIS
.nf
\fBdb2shakemap_xml \fP[-j] [-version \fIversion\fP] -event \fIevent_id\fP
.fi
.SH DESCRIPTION
Given a database of earthquake information and a specified event identifier,
\fBdb2shakemap_xml\fP creates input files in XML (eXtensible Markup Language) for
the US Geological Survey's ShakeMap program.

To maintain command-line argument consistency with ShakeMap, most option specifications
for \fBdb2shakemap_xml\fP are in the parameter-file, which by default is named \fBdb2shakemap_xml\fP.pf.

\fBdb2shakemap_xml\fP runs on a Datascope database in rt1.0 format (css3.0 compatible). The
pathname of this database should be specified in the \fIdbname\fP parameter of the parameter
file. There are two basic modes of operation for \fBdb2shakemap_xml\fP. In the first, default,
mode, the \fIevent_id\fP specified on the command line is interpreted as an evid, which
is sought in the given database. In the second, 'jdate', mode, the \fIevent_id\fP may be
either an evid or a string of the form jdate_evid. This mode is triggered by specifying the
-j option to \fBdb2shakemap_xml\fP. In jdate mode, the \fIdbname\fP
parameter is interpreted as a pattern for the epoch2str(3) command, and the jdate
gives the time for which that pattern is evaluated. For example, if \fIdbname\fP is
.ft CW
.in 2c
.nf
.ne 3

        dbname /ymp16/%Y/%j/reno

.fi
.in
.ft R
and \fBdb2shakemap_xml\fP is run with the command-line
.ft CW
.in 2c
.nf
.ne 3

        \fBdb2shakemap_xml\fP -j -event 2002266_20

.fi
.in
.ft R
the program tries to find evid 20 in the database named /ymp16/2002/266/reno.

The \fIearthquake_dtd\fP and \fIwfdata_dtd\fP parameters of the parameter-file specify
filenames in which to find the Document Type Definitions (DTDs) for earthquake and stationlist
XML output, respectively. Likewise, the \fIoutput_dir\fP parameter specifies where to put
the output results and the parameters \fIearthquake_filename\fP and \fIwfdata_filename\fP
specify the files in which to write the XML results.

Four parameters control which data are used in forming the XML output.
The \fIorigin_subset\fP parameter limits processing to those hypocenters
which match the specified criteria, for example earthquakes with ml
greater than a specified threshold. This is often useful to prevent
generation of ShakeMaps for earthquakes that are too small. The
\fIcontaining_polygon\fP parameter is a table of comma-separated lat,lon
pairs (one pair on each line) which may be used to limit the XML
generation to earthquakes inside a given polygon region. The
\fIwfmeas_subset\fP parameter allows subsetting of the input wfmeas-rows.
Finally, different real-time systems may produce varying relationships
between hypocentral (origin) rows and their accompanying measurement
(wfmeas) rows. To specify how to connect database wfmeas rows to origin
rows, the \fIdbwfmeas_thetajoin_recipe\fP parameter should be set
appropriately.  This expression is then fed to the Datascope dbtheta(3)
command. A common example is shown in the PARAMETER FILE section
below.

Several parameters allow additional attributes of the output XML to be filled in.
The \fIplaces_dbname\fP parameter gives the pathname of a database in places1.2 format,
yielding the names and locations of nearby places of interest. The \fIinsttype\fP and \fIcommtype\fP
parameters allow the corresponding attributes of the XML station entries to be
filled in (for more detail see the ShakeMap documentation).

.SH OPTIONS
.IP "-event event_id"
This required argument specifies the event-id for the desired earthquake. Without
the -j option, \fIevent_id\fP is interpreted as an evid in the database. With -j, it may be
interpreted as jdate_evid with the jdate used to fill in the exact name of the
database via the epoch2str(3) command.

.IP -j
jdate mode. Attempts to interpret the \fIevent_id\fP as a jdate_evid combination (e.g.
2002266_20), in which the first part is the julian date of earthquake occurrence
and the second part is the actual database evid (If this parsing fails, it
assumes the \fIevent_id\fP is equivalent to the evid). Regardless of whether the parsing succeeds,
the output XML files are written with \fIevent_id\fP as jdate_evid. The -j option
is useful in conjunction with the dbcentral(1) command to manage earthquakes that
are spread across multiple day or month volumes.

.IP "-version version" 
Specify ShakeMap version for output XML. Currently only ShakeMap 2.4 is supported.

.SH PARAMETER FILE
.ft CW
.in 2c
.nf

.ne 7
dbname                  db/reno
earthquake_dtd          /opt/ShakeMap/lib/xml/earthquake.dtd
wfdata_dtd              /opt/ShakeMap/lib/xml/stationlist.dtd
output_dir              /opt/ShakeMap/data/$\fIevent_id\fP/input
earthquake_filename     event.xml
wfdata_filename         db_dat.xml
places_dbname           /ymp13/ANTELOPE/RENO/places/new_nevada

.ne 9
origin_subset           ml >= 3
wfmeas_subset           filter =~ /.*/

# To specify how to join origin-assoc-arrival view rows to the wfmeas table,
# the wfmeas_thetajoin_recipe parameter must be set to an expression that
# is fed to dbtheta. If the arids are correctly set in the wfmeas
# table of the running system, this may be as simple as
#       wfmeas_thetajoin_recipe arid == wfmeas.arid
# Otherwise a common strategy is shown below:

.ne 11
wfmeas_thetajoin_recipe         sta == wfmeas.sta && chan == wfmeas.chan && wfmeas.time == arrival.time - 10

insttype                UNR
commtype                DIG

containing_polygon &Tbl{
        42,-120
        42,-114
        35,-114
        39,-120
}

meastype_xmltags &Arr{
        peaka   acc
        peakv   vel
        acc     acc
        vel     vel
        psa30   psa30
        psa10   psa10
        psa03   psa03
}

.fi
.in
.ft R
.SH EXAMPLE
.ft CW
.in 2c
.nf

.ne 7

nickel%\fB db2shakemap_xml -j -event 2002266_20\fP
nickel%\fB ls\fP
db_dat.xml
event.xml
nickel%\fB \fP

.fi
.in
.ft R
.SH "RETURN VALUES"
\fBdb2shakemap_xml\fP exits with status 0 upon success, nonzero upon error. 
.SH "SEE ALSO"
.nf
dbcentral(1), db2xml(1)
.fi
.SH AUTHOR
.nf
Kent Lindquist
Lindquist Consulting
.fi

.\" $Id$
