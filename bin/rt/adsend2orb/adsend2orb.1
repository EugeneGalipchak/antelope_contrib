.\" $Name$ $Date$
.TH ADSEND2ORB 1
.SH NAME
adsend2orb  \- Take Earthworm analog data from internet and put on ORB
.SH SYNOPSIS
.nf
adsend2orb orbname adsend_port
.fi
.SH DESCRIPTION
adsend2orb reads multiplexed Earthworm data in packets of TYPE_ADBUF from 
a UDP port number specified on the command line. These packets are demultiplexed
and recast into packets for the Datascope ORB. 

The conversion between the scan order of channels in the multiplexer and 
the net, sta, and channel names for the ORB packet is taken from the database
specified by the SITE_DB environment variable. The scan order of channels is 
taken as the adchan field of the ewanalog table; the net, station, and channel
names are taken from the pins table. Stations listed with pins.savechan set to 
"n" are not saved to the ORB. The data packets are saved to the ORB in 
Iceworm-Trace-Buffer format, so the pin-number is taken from the pins table
and placed into the packets. If the optional calibration table is present
in the site database, the calib field for listed stations is filled into the
orb-packet header. Otherwise the calib info in the header is left at the NULL 
value. If the optional timecorr table is present in the site database, stations
with nonzero entries for the commdelay field have their start-times shifted 
accordingly before the packets are placed on the ORB. If any of these tables
are modified, adsend2orb dynamically rereads the database and adjusts the 
demultiplexing accordingly. This allows the user to change calibration information,
change multiplexer data-channel assignments, and turn stations on or off without
having to restart either the digitizer or the adsend2orb module.

The parameter file specifies whether to compress the data with the gencompress
algorithm; and also whether to swap the bytes of the TYPE_ADBUF packets
before decoding them. None, some, or all of the Earthworm packet logo may be 
put in the parameter file: the integers for installation ID, earthworm 
module ID, and TYPE_ADBUF type id, specified as shown below. If these are
specified, packets which do not match are rejected. The ewADBUF_TYPE parameter
is recommended, in order to reject other types of messages such as heartbeats. 
These integers are usually specified in the earthworm.d parameter file of
the sending institution.
.SH OPTIONS
.SH FILES
adsend2orb requires the parameter file adsend2orb.pf. Also, adsend2orb bases
its decoding (station-naming, whether to ignore stations or not) on four tables
of a database in iceworm1.3 schema format: those tables are the pins table, the 
ewanalog table, the calibration table, and the timecorr table. The pins table
and the ewanalog table are required.
.SH ENVIRONMENT
SITE_DB contains the name of a database in iceworm1.3 schema format. PFPATH 
must contain the path to the parameter file. 
.SH PARAMETER FILE
.nf
nordic% pfecho adsend2orb.pf
compress        0 	# Whether to compress data when putting it on the ORB
ewADBUF_TYPE 	1	# optional type-id number: earthworm TYPE_ADBUF
ewMOD 		1	# optional earthworm module id number 
ewINST 		1	# optional earthworm installation id number
swap_bytes      1	# whether to swap byte order of incoming data
nordic%
.fi
.SH EXAMPLE
nordic% adsend2orb localhost 9900
.RS .2i
.RE
.SH RETURN VALUES
.SH LIBRARY
.SH DIAGNOSTICS
.nf
FATAL:

Usage: adsend2orb orbname adsend_port
adsend2orb: missing or incorrect parameter file
adsend2orb: failed to create mutex
adsend2orb: Failed to create input thread
adsend2orb: environment variable SITE_DB not set
adsend2orb: pins table not present in $SITE_DB
adsend2orb: ewanalog table not present in $SITE_DB
adsend2orb: Can't open the socket
adsend2orb: Error permitting socket address reuse
adsend2orb: Can't bind address to socket

NON-FATAL:

adsend2orb: gencompress error			
adsend2orb: orbput failed for [source id string]
adsend2orb: lost [number of] messages for inst_mod_type [Earthworm logo numbers], got # [sequence num] expecting # [sequence num]
.fi
.SH "SEE ALSO"
.nf
orbserver(1), gencompress(3), dbe(1)
.fi
.SH "BUGS AND CAVEATS"
adsend2orb uses file modification time of the tables in $SITE_DB in order
to decide whether to reread the site database. Modifying those tables with 
dbe does not change the modification time of the actual files until one 
quits the dbe program.

adsend2orb intentionally ignores the array of pin-numbers sent by the 
adsend software in the TYPE_ADBUF data packets. Adsend2orb relies solely
on the packing order of those packets, which it assumes is specified by 
the "adchan" field of the ewanalog table of the site database. This allows
the operator to change channel assignments without having to stop the digitizing
PC to change the setup file for adsend.

adsend2orb does not dynamically reread its parameter file.
.SH AUTHOR
.nf
Kent Lindquist
University of Alaska
Geophysical Institute

(recasting a few lines of coaxtoring.c from the USGS Earthworm 
group in order to take in UDP packets and recast into TYPE_ADBUF
messages.)
.fi
