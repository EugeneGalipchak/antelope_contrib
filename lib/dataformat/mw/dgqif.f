      subroutine dgqif(a,b,result,k,rtol,atol,istop,icheck,f,rpar,ipar)
c
c  this subroutine attempts to calculate the integral of a function
c  from a to b with relative accuracy rtol and absolute accuracy atol.
c  the integration is obtained using a sequence of 1,3,7,15,31,63,127,
c  and 255 point interlacing gauss formula so that no integrand
c  evaluations are wasted; these correspond to 1,5,11,23,47,95,191,
c  and 383 order polynomials respectively. details of the formulae are
c  contained in t.n.l. patterson, maths.comp. 22,847-856 (1968) and
c  weights are taken from a.c.m algorithm 468.
c
c  **input**
c
c  a      lower limit of integration
c  b      upper limit of integration
c  rtol   relative accuracy required. when the relative difference of
c         two successive formulae does not exceed rtol the last formula
c         computed is used as the result
c  atol   absolute accuracy required. when the absolute difference of
c         two successive formulae does not exceed atol the last formula
c         computed is used as the result
c  istop  if istop=1,..7 then termination occurs at the corresponding
c         gauss order.
c  f      external function to evaluate the integrand. the call is of
c         the form
c                 result=f(x,rpar,ipar)
c         where x is the argument and result is the integrand value
c  rpar   vector of double precision parameters to pass to f
c  ipar   vector of integer parameters to pass to f
c
c  **output**
c
c  result array containing the result obtained at each gauss order
c  k      index of highest gauss order used (1.le.k.le.8)
c  icheck error flag, set to zero on normal return and set to 1 if
c         convergence is not obtained.
c
c  a. chave igpp/ucsd jan 1983
c
c  calls dot
c
      implicit double precision (a-h,o-z)
      dimension result(8),wt(254),wa(127),funct(127),
     $          nwa(7),nwt(7),rpar(1),ipar(1)
c  starting addresses in arrays wt and wa at each order
      data nwt/1,3,7,15,31,63,127/,nwa/1,2,4,8,16,32,64/
      data (wt(i),i=1,20)/
     $0.55555555555555555556d+00,0.88888888888888888889d+00,
     $0.26848808986833344073d+00,0.10465622602646726519d+00,
     $0.40139741477596222291d+00,0.45091653865847414235d+00,
     $0.13441525524378422036d+00,0.51603282997079739697d-01,
     $0.20062852937698902103d+00,0.17001719629940260339d-01,
     $0.92927195315124537686d-01,0.17151190913639138079d+00,
     $0.21915685840158749640d+00,0.22551049979820668739d+00,
     $0.67207754295990703540d-01,0.25807598096176653565d-01,
     $0.10031427861179557877d+00,0.84345657393211062463d-02,
     $0.46462893261757986541d-01,0.85755920049990351154d-01/
      data (wt(i),i=21,40)/
     $0.10957842105592463824d+00,0.25447807915618744154d-02,
     $0.16446049854387810934d-01,0.35957103307129322097d-01,
     $0.56979509494123357412d-01,0.76879620499003531043d-01,
     $0.93627109981264473617d-01,0.10566989358023480974d+00,
     $0.11195687302095345688d+00,0.11275525672076869161d+00,
     $0.33603877148207730542d-01,0.12903800100351265626d-01,
     $0.50157139305899537414d-01,0.42176304415588548391d-02,
     $0.23231446639910269443d-01,0.42877960025007734493d-01,
     $0.54789210527962865032d-01,0.12651565562300680114d-02,
     $0.82230079572359296693d-02,0.17978551568128270333d-01/
      data (wt(i),i=41,60)/
     $0.28489754745833548613d-01,0.38439810249455532039d-01,
     $0.46813554990628012403d-01,0.52834946790116519862d-01,
     $0.55978436510476319408d-01,0.36322148184553065969d-03,
     $0.25790497946856882724d-02,0.61155068221172463397d-02,
     $0.10498246909621321898d-01,0.15406750466559497802d-01,
     $0.20594233915912711149d-01,0.25869679327214746911d-01,
     $0.31073551111687964880d-01,0.36064432780782572640d-01,
     $0.40715510116944318934d-01,0.44914531653632197414d-01,
     $0.48564330406673198716d-01,0.51583253952048458777d-01,
     $0.53905499335266063927d-01,0.55481404356559363988d-01/
      data (wt(i),i=61,80)/
     $0.56277699831254301273d-01,0.56377628360384717388d-01,
     $0.16801938574103865271d-01,0.64519000501757369228d-02,
     $0.25078569652949768707d-01,0.21088152457266328793d-02,
     $0.11615723319955134727d-01,0.21438980012503867246d-01,
     $0.27394605263981432516d-01,0.63260731936263354422d-03,
     $0.41115039786546930472d-02,0.89892757840641357233d-02,
     $0.14244877372916774306d-01,0.19219905124727766019d-01,
     $0.23406777495314006201d-01,0.26417473395058259931d-01,
     $0.27989218255238159704d-01,0.18073956444538835782d-03,
     $0.12895240826104173921d-02,0.30577534101755311361d-02/
      data (wt(i),i=81,100)/
     $0.52491234548088591251d-02,0.77033752332797418482d-02,
     $0.10297116957956355524d-01,0.12934839663607373455d-01,
     $0.15536775555843982440d-01,0.18032216390391286320d-01,
     $0.20357755058472159467d-01,0.22457265826816098707d-01,
     $0.24282165203336599358d-01,0.25791626976024229388d-01,
     $0.26952749667633031963d-01,0.27740702178279681994d-01,
     $0.28138849915627150636d-01,0.50536095207862517625d-04,
     $0.37774664632698466027d-03,0.93836984854238150079d-03,
     $0.16811428654214699063d-02,0.25687649437940203731d-02,
     $0.35728927835172996494d-02,0.46710503721143217474d-02/
      data (wt(i),i=101,120)/
     $0.58434498758356395076d-02,0.70724899954335554680d-02,
     $0.83428387539681577056d-02,0.96411777297025366953d-02,
     $0.10955733387837901648d-01,0.12275830560082770087d-01,
     $0.13591571009765546790d-01,0.14893641664815182035d-01,
     $0.16173218729577719942d-01,0.17421930159464173747d-01,
     $0.18631848256138790186d-01,0.19795495048097499488d-01,
     $0.20905851445812023852d-01,0.21956366305317824939d-01,
     $0.22940964229387748761d-01,0.23854052106038540080d-01,
     $0.24690524744487676909d-01,0.25445769965464765813d-01,
     $0.26115673376706097680d-01,0.26696622927450359906d-01/
      data (wt(i),i=121,140)/
     $0.27185513229624791819d-01,0.27579749566481873035d-01,
     $0.27877251476613701609d-01,0.28076455793817246607d-01,
     $0.28176319033016602131d-01,0.28188814180192358694d-01,
     $0.84009692870519326354d-02,0.32259500250878684614d-02,
     $0.12539284826474884353d-01,0.10544076228633167722d-02,
     $0.58078616599775673635d-02,0.10719490006251933623d-01,
     $0.13697302631990716258d-01,0.31630366082226447689d-03,
     $0.20557519893273465236d-02,0.44946378920320678616d-02,
     $0.71224386864583871532d-02,0.96099525623638830097d-02,
     $0.11703388747657003101d-01,0.13208736697529129966d-01/
      data (wt(i),i=141,160)/
     $0.13994609127619079852d-01,0.90372734658751149261d-04,
     $0.64476204130572477933d-03,0.15288767050877655684d-02,
     $0.26245617274044295626d-02,0.38516876166398709241d-02,
     $0.51485584789781777618d-02,0.64674198318036867274d-02,
     $0.77683877779219912200d-02,0.90161081951956431600d-02,
     $0.10178877529236079733d-01,0.11228632913408049354d-01,
     $0.12141082601668299679d-01,0.12895813488012114694d-01,
     $0.13476374833816515982d-01,0.13870351089139840997d-01,
     $0.14069424957813575318d-01,0.25157870384280661489d-04,
     $0.18887326450650491366d-03,0.46918492424785040975d-03/
      data (wt(i),i=161,180)/
     $0.84057143271072246365d-03,0.12843824718970101768d-02,
     $0.17864463917586498247d-02,0.23355251860571608737d-02,
     $0.29217249379178197538d-02,0.35362449977167777340d-02,
     $0.41714193769840788528d-02,0.48205888648512683476d-02,
     $0.54778666939189508240d-02,0.61379152800413850435d-02,
     $0.67957855048827733948d-02,0.74468208324075910174d-02,
     $0.80866093647888599710d-02,0.87109650797320868736d-02,
     $0.93159241280693950932d-02,0.98977475240487497440d-02,
     $0.10452925722906011926d-01,0.10978183152658912470d-01,
     $0.11470482114693874380d-01,0.11927026053019270040d-01/
      data (wt(i),i=181,200)/
     $0.12345262372243838455d-01,0.12722884982732382906d-01,
     $0.13057836688353048840d-01,0.13348311463725179953d-01,
     $0.13592756614812395910d-01,0.13789874783240936517d-01,
     $0.13938625738306850804d-01,0.14038227896908623303d-01,
     $0.14088159516508301065d-01,0.69379364324108267170d-05,
     $0.53275293669780613125d-04,0.13575491094922871973d-03,
     $0.24921240048299729402d-03,0.38974528447328229322d-03,
     $0.55429531493037471492d-03,0.74028280424450333046d-03,
     $0.94536151685852538246d-03,0.11674841174299594077d-02,
     $0.14049079956551446427d-02,0.16561127281544526052d-02/
      data (wt(i),i=201,220)/
     $0.19197129710138724125d-02,0.21944069253638388388d-02,
     $0.24789582266575679307d-02,0.27721957645934509940d-02,
     $0.30730184347025783234d-02,0.33803979910869203823d-02,
     $0.36933779170256508183d-02,0.40110687240750233989d-02,
     $0.43326409680929828545d-02,0.46573172997568547773d-02,
     $0.49843645647655386012d-02,0.53130866051870565663d-02,
     $0.56428181013844441585d-02,0.59729195655081658049d-02,
     $0.63027734490857587172d-02,0.66317812429018878941d-02,
     $0.69593614093904229394d-02,0.72849479805538070639d-02,
     $0.76079896657190565832d-02,0.79279493342948491103d-02/
      data (wt(i),i=221,240)/
     $0.82443037630328680306d-02,0.85565435613076896192d-02,
     $0.88641732094824942641d-02,0.91667111635607884067d-02,
     $0.94636899938300652943d-02,0.97546565363174114611d-02,
     $0.10039172044056840798d-01,0.10316812330947621682d-01,
     $0.10587167904885197931d-01,0.10849844089337314099d-01,
     $0.11104461134006926537d-01,0.11350654315980596602d-01,
     $0.11588074033043952568d-01,0.11816385890830235763d-01,
     $0.12035270785279562630d-01,0.12244424981611985899d-01,
     $0.12443560190714035263d-01,0.12632403643542078765d-01,
     $0.12810698163877361967d-01,0.12978202239537399286d-01/
      data (wt(i),i=241,254)/
     $0.13134690091960152836d-01,0.13279951743930530650d-01,
     $0.13413793085110098513d-01,0.13536035934956213614d-01,
     $0.13646518102571291428d-01,0.13745093443001896632d-01,
     $0.13831631909506428676d-01,0.13906019601325461264d-01,
     $0.13968158806516938516d-01,0.14017968039456608810d-01,
     $0.14055382072649964277d-01,0.14080351962553661325d-01,
     $0.14092845069160408355d-01,0.14094407090096179347d-01/
      data (wa(i),i=1,20)/
     $0.77459666924148337704d+00,0.96049126870802028342d+00,
     $0.43424374934680255800d+00,0.99383196321275502221d+00,
     $0.88845923287225699889d+00,0.62110294673722640294d+00,
     $0.22338668642896688163d+00,0.99909812496766759766d+00,
     $0.98153114955374010687d+00,0.92965485742974005667d+00,
     $0.83672593816886873550d+00,0.70249620649152707861d+00,
     $0.53131974364437562397d+00,0.33113539325797683309d+00,
     $0.11248894313318662575d+00,0.99987288812035761194d+00,
     $0.99720625937222195908d+00,0.98868475754742947994d+00,
     $0.97218287474858179658d+00,0.94634285837340290515d+00/
      data (wa(i),i=21,40)/
     $0.91037115695700429250d+00,0.86390793819369047715d+00,
     $0.80694053195021761186d+00,0.73975604435269475868d+00,
     $0.66290966002478059546d+00,0.57719571005204581484d+00,
     $0.48361802694584102756d+00,0.38335932419873034692d+00,
     $0.27774982202182431507d+00,0.16823525155220746498d+00,
     $0.56344313046592789972d-01,0.99998243035489159858d+00,
     $0.99959879967191068325d+00,0.99831663531840739253d+00,
     $0.99572410469840718851d+00,0.99149572117810613240d+00,
     $0.98537149959852037111d+00,0.97714151463970571416d+00,
     $0.96663785155841656709d+00,0.95373000642576113641d+00/
      data (wa(i),i=41,60)/
     $0.93832039777959288365d+00,0.92034002547001242073d+00,
     $0.89974489977694003664d+00,0.87651341448470526974d+00,
     $0.85064449476835027976d+00,0.82215625436498040737d+00,
     $0.79108493379984836143d+00,0.75748396638051363793d+00,
     $0.72142308537009891548d+00,0.68298743109107922809d+00,
     $0.64227664250975951377d+00,0.59940393024224289297d+00,
     $0.55449513263193254887d+00,0.50768775753371660215d+00,
     $0.45913001198983233287d+00,0.40897982122988867241d+00,
     $0.35740383783153215238d+00,0.30457644155671404334d+00,
     $0.25067873030348317661d+00,0.19589750271110015392d+00/
      data (wa(i),i=61,80)/
     $0.14042423315256017459d+00,0.84454040083710883710d-01,
     $0.28184648949745694339d-01,0.99999759637974846462d+00,
     $0.99994399620705437576d+00,0.99976049092443204733d+00,
     $0.99938033802502358193d+00,0.99874561446809511470d+00,
     $0.99780535449595727456d+00,0.99651414591489027385d+00,
     $0.99483150280062100052d+00,0.99272134428278861533d+00,
     $0.99015137040077015918d+00,0.98709252795403406719d+00,
     $0.98351865757863272876d+00,0.97940628167086268381d+00,
     $0.97473445975240266776d+00,0.96948465950245923177d+00,
     $0.96364062156981213252d+00,0.95718821610986096274d+00/
      data (wa(i),i=81,100)/
     $0.95011529752129487656d+00,0.94241156519108305981d+00,
     $0.93406843615772578800d+00,0.92507893290707565236d+00,
     $0.91543758715576504064d+00,0.90514035881326159519d+00,
     $0.89418456833555902286d+00,0.88256884024734190684d+00,
     $0.87029305554811390585d+00,0.85735831088623215653d+00,
     $0.84376688267270860104d+00,0.82952219463740140018d+00,
     $0.81462878765513741344d+00,0.79909229096084140180d+00,
     $0.78291939411828301639d+00,0.76611781930376009072d+00,
     $0.74869629361693660282d+00,0.73066452124218126133d+00,
     $0.71203315536225203459d+00,0.69281376977911470289d+00/
      data (wa(i),i=101,120)/
     $0.67301883023041847920d+00,0.65266166541001749610d+00,
     $0.63175643771119423041d+00,0.61031811371518640016d+00,
     $0.58836243444766254143d+00,0.56590588542365442262d+00,
     $0.54296566649831149049d+00,0.51955966153745702199d+00,
     $0.49570640791876146017d+00,0.47142506587165887693d+00,
     $0.44673538766202847374d+00,0.42165768662616330006d+00,
     $0.39621280605761593918d+00,0.37042208795007823014d+00,
     $0.34430734159943802278d+00,0.31789081206847668318d+00,
     $0.29119514851824668196d+00,0.26424337241092676194d+00,
     $0.23705884558982972721d+00,0.20966523824318119477d+00/
      data (wa(i),i=121,127)/
     $0.18208649675925219825d+00,0.15434681148137810869d+00,
     $0.12647058437230196685d+00,0.98482396598119202090d-01,
     $0.70406976042855179063d-01,0.42269164765363603212d-01,
     $0.14093886410782462614d-01/
c
c  check for trivial case
      if(a.eq.b)then
        result(1)=0.
        k=1
        icheck=1
        return
      endif
      if((istop.lt.1).or.(istop.gt.7))istop=7
c  scale factors
      sum=(b+a)/2.
      diff=(b-a)/2.
c  one point gauss
      fzero=f(sum,rpar,ipar)
      result(1)=2.*fzero*diff
      i=1
      k=1
c  step through the gauss orders until convergence is obtained
      do 20 n=1,istop
c  compute new function values
        na=nwa(n)
        do 10 j=1,nwa(n)
          x=wa(na)*diff
          na=na+1
          f1=f(sum+x,rpar,ipar)
          f2=f(sum-x,rpar,ipar)
          funct(i)=f1+f2
          i=i+1
   10   continue
c  compute dot product of function values with weights
        nw=nwt(n)
        acum=dot(nw,wt(nw),1,funct(1),1)
        k=k+1
        result(k)=(acum+wt(2*nw)*fzero)*diff
c  check for convergence
        if(abs(result(k)-result(k-1)).le.rtol*abs(result(k))+atol)then
          icheck=0
          return
        endif
   20 continue
      icheck=1
      return
      end

c $Id$ 
